<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>main.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Tily.ActiveTile.html">ActiveTile</a><ul class='methods'><li data-type='method'><a href="Tily.ActiveTile.html#.fromData">fromData</a></li><li data-type='method'><a href="Tily.ActiveTile.html#addLayer">addLayer</a></li><li data-type='method'><a href="Tily.ActiveTile.html#animateForeground">animateForeground</a></li><li data-type='method'><a href="Tily.ActiveTile.html#animateOffset">animateOffset</a></li><li data-type='method'><a href="Tily.ActiveTile.html#animateOpacity">animateOpacity</a></li><li data-type='method'><a href="Tily.ActiveTile.html#animateRotation">animateRotation</a></li><li data-type='method'><a href="Tily.ActiveTile.html#animateScale">animateScale</a></li><li data-type='method'><a href="Tily.ActiveTile.html#draw">draw</a></li><li data-type='method'><a href="Tily.ActiveTile.html#getData">getData</a></li><li data-type='method'><a href="Tily.ActiveTile.html#moveLayer">moveLayer</a></li><li data-type='method'><a href="Tily.ActiveTile.html#removeAllLayers">removeAllLayers</a></li><li data-type='method'><a href="Tily.ActiveTile.html#removeLayer">removeLayer</a></li></ul></li><li><a href="Tily.ActiveTileBase.html">ActiveTileBase</a><ul class='methods'><li data-type='method'><a href="Tily.ActiveTileBase.html#addLayer">addLayer</a></li><li data-type='method'><a href="Tily.ActiveTileBase.html#animateForeground">animateForeground</a></li><li data-type='method'><a href="Tily.ActiveTileBase.html#animateOffset">animateOffset</a></li><li data-type='method'><a href="Tily.ActiveTileBase.html#animateOpacity">animateOpacity</a></li><li data-type='method'><a href="Tily.ActiveTileBase.html#animateRotation">animateRotation</a></li><li data-type='method'><a href="Tily.ActiveTileBase.html#animateScale">animateScale</a></li><li data-type='method'><a href="Tily.ActiveTileBase.html#draw">draw</a></li><li data-type='method'><a href="Tily.ActiveTileBase.html#moveLayer">moveLayer</a></li><li data-type='method'><a href="Tily.ActiveTileBase.html#removeAllLayers">removeAllLayers</a></li><li data-type='method'><a href="Tily.ActiveTileBase.html#removeLayer">removeLayer</a></li></ul></li><li><a href="Tily.ActiveTileLayer.html">ActiveTileLayer</a><ul class='methods'><li data-type='method'><a href="Tily.ActiveTileLayer.html#.fromData">fromData</a></li><li data-type='method'><a href="Tily.ActiveTileLayer.html#addLayer">addLayer</a></li><li data-type='method'><a href="Tily.ActiveTileLayer.html#animateForeground">animateForeground</a></li><li data-type='method'><a href="Tily.ActiveTileLayer.html#animateOffset">animateOffset</a></li><li data-type='method'><a href="Tily.ActiveTileLayer.html#animateOpacity">animateOpacity</a></li><li data-type='method'><a href="Tily.ActiveTileLayer.html#animateRotation">animateRotation</a></li><li data-type='method'><a href="Tily.ActiveTileLayer.html#animateScale">animateScale</a></li><li data-type='method'><a href="Tily.ActiveTileLayer.html#animateText">animateText</a></li><li data-type='method'><a href="Tily.ActiveTileLayer.html#draw">draw</a></li><li data-type='method'><a href="Tily.ActiveTileLayer.html#getData">getData</a></li><li data-type='method'><a href="Tily.ActiveTileLayer.html#moveLayer">moveLayer</a></li><li data-type='method'><a href="Tily.ActiveTileLayer.html#removeAllLayers">removeAllLayers</a></li><li data-type='method'><a href="Tily.ActiveTileLayer.html#removeLayer">removeLayer</a></li></ul></li><li><a href="Tily.Animation.html">Animation</a><ul class='methods'><li data-type='method'><a href="Tily.Animation.html#update">update</a></li></ul></li><li><a href="Tily.Buffer.html">Buffer</a><ul class='methods'><li data-type='method'><a href="Tily.Buffer.html#.deserialize">deserialize</a></li><li data-type='method'><a href="Tily.Buffer.html#.fromData">fromData</a></li><li data-type='method'><a href="Tily.Buffer.html#addActiveTile">addActiveTile</a></li><li data-type='method'><a href="Tily.Buffer.html#addLayer">addLayer</a></li><li data-type='method'><a href="Tily.Buffer.html#draw">draw</a></li><li data-type='method'><a href="Tily.Buffer.html#getData">getData</a></li><li data-type='method'><a href="Tily.Buffer.html#getPosition">getPosition</a></li><li data-type='method'><a href="Tily.Buffer.html#getTileInfo">getTileInfo</a></li><li data-type='method'><a href="Tily.Buffer.html#moveLayer">moveLayer</a></li><li data-type='method'><a href="Tily.Buffer.html#moveOffset">moveOffset</a></li><li data-type='method'><a href="Tily.Buffer.html#removeActiveTile">removeActiveTile</a></li><li data-type='method'><a href="Tily.Buffer.html#removeAllActiveTiles">removeAllActiveTiles</a></li><li data-type='method'><a href="Tily.Buffer.html#removeAllLayers">removeAllLayers</a></li><li data-type='method'><a href="Tily.Buffer.html#removeLayer">removeLayer</a></li><li data-type='method'><a href="Tily.Buffer.html#resize">resize</a></li><li data-type='method'><a href="Tily.Buffer.html#serialize">serialize</a></li><li data-type='method'><a href="Tily.Buffer.html#updateActiveTilesMap">updateActiveTilesMap</a></li><li data-type='method'><a href="Tily.Buffer.html#updateTransitions">updateTransitions</a></li><li data-type='method'><a href="Tily.Buffer.html#zoom">zoom</a></li></ul></li><li><a href="Tily.BufferBase.html">BufferBase</a><ul class='methods'><li data-type='method'><a href="Tily.BufferBase.html#addActiveTile">addActiveTile</a></li><li data-type='method'><a href="Tily.BufferBase.html#getPosition">getPosition</a></li><li data-type='method'><a href="Tily.BufferBase.html#getTileInfo">getTileInfo</a></li><li data-type='method'><a href="Tily.BufferBase.html#moveOffset">moveOffset</a></li><li data-type='method'><a href="Tily.BufferBase.html#removeActiveTile">removeActiveTile</a></li><li data-type='method'><a href="Tily.BufferBase.html#removeAllActiveTiles">removeAllActiveTiles</a></li><li data-type='method'><a href="Tily.BufferBase.html#updateActiveTilesMap">updateActiveTilesMap</a></li><li data-type='method'><a href="Tily.BufferBase.html#updateTransitions">updateTransitions</a></li><li data-type='method'><a href="Tily.BufferBase.html#zoom">zoom</a></li></ul></li><li><a href="Tily.BufferTransition.html">BufferTransition</a><ul class='methods'><li data-type='method'><a href="Tily.BufferTransition.html#update">update</a></li></ul></li><li><a href="Tily.Cell.html">Cell</a><ul class='methods'><li data-type='method'><a href="Tily.Cell.html#.deserialize">deserialize</a></li><li data-type='method'><a href="Tily.Cell.html#.fromData">fromData</a></li><li data-type='method'><a href="Tily.Cell.html#addLayer">addLayer</a></li><li data-type='method'><a href="Tily.Cell.html#draw">draw</a></li><li data-type='method'><a href="Tily.Cell.html#getData">getData</a></li><li data-type='method'><a href="Tily.Cell.html#moveLayer">moveLayer</a></li><li data-type='method'><a href="Tily.Cell.html#removeAllLayers">removeAllLayers</a></li><li data-type='method'><a href="Tily.Cell.html#removeLayer">removeLayer</a></li><li data-type='method'><a href="Tily.Cell.html#serialize">serialize</a></li></ul></li><li><a href="Tily.CellBuffer.html">CellBuffer</a><ul class='methods'><li data-type='method'><a href="Tily.CellBuffer.html#.deserialize">deserialize</a></li><li data-type='method'><a href="Tily.CellBuffer.html#addActiveTile">addActiveTile</a></li><li data-type='method'><a href="Tily.CellBuffer.html#draw">draw</a></li><li data-type='method'><a href="Tily.CellBuffer.html#getPosition">getPosition</a></li><li data-type='method'><a href="Tily.CellBuffer.html#getTileInfo">getTileInfo</a></li><li data-type='method'><a href="Tily.CellBuffer.html#moveOffset">moveOffset</a></li><li data-type='method'><a href="Tily.CellBuffer.html#removeActiveTile">removeActiveTile</a></li><li data-type='method'><a href="Tily.CellBuffer.html#removeAllActiveTiles">removeAllActiveTiles</a></li><li data-type='method'><a href="Tily.CellBuffer.html#serialize">serialize</a></li><li data-type='method'><a href="Tily.CellBuffer.html#updateActiveTilesMap">updateActiveTilesMap</a></li><li data-type='method'><a href="Tily.CellBuffer.html#updateTransitions">updateTransitions</a></li><li data-type='method'><a href="Tily.CellBuffer.html#zoom">zoom</a></li></ul></li><li><a href="Tily.ForegroundAnimation.html">ForegroundAnimation</a><ul class='methods'><li data-type='method'><a href="Tily.ForegroundAnimation.html#update">update</a></li></ul></li><li><a href="Tily.Main.html">Main</a><ul class='methods'><li data-type='method'><a href="Tily.Main.html#activateBuffer">activateBuffer</a></li><li data-type='method'><a href="Tily.Main.html#draw">draw</a></li></ul></li><li><a href="Tily.OffsetAnimation.html">OffsetAnimation</a><ul class='methods'><li data-type='method'><a href="Tily.OffsetAnimation.html#update">update</a></li></ul></li><li><a href="Tily.OffsetTransition.html">OffsetTransition</a><ul class='methods'><li data-type='method'><a href="Tily.OffsetTransition.html#update">update</a></li></ul></li><li><a href="Tily.OpacityAnimation.html">OpacityAnimation</a><ul class='methods'><li data-type='method'><a href="Tily.OpacityAnimation.html#update">update</a></li></ul></li><li><a href="Tily.RotationAnimation.html">RotationAnimation</a><ul class='methods'><li data-type='method'><a href="Tily.RotationAnimation.html#update">update</a></li></ul></li><li><a href="Tily.ScaleAnimation.html">ScaleAnimation</a><ul class='methods'><li data-type='method'><a href="Tily.ScaleAnimation.html#update">update</a></li></ul></li><li><a href="Tily.ScaleTransition.html">ScaleTransition</a><ul class='methods'><li data-type='method'><a href="Tily.ScaleTransition.html#update">update</a></li></ul></li><li><a href="Tily.TextAnimation.html">TextAnimation</a><ul class='methods'><li data-type='method'><a href="Tily.TextAnimation.html#update">update</a></li></ul></li><li><a href="Tily.TileLayer.html">TileLayer</a><ul class='methods'><li data-type='method'><a href="Tily.TileLayer.html#.fromData">fromData</a></li><li data-type='method'><a href="Tily.TileLayer.html#clear">clear</a></li><li data-type='method'><a href="Tily.TileLayer.html#draw">draw</a></li><li data-type='method'><a href="Tily.TileLayer.html#fill">fill</a></li><li data-type='method'><a href="Tily.TileLayer.html#getData">getData</a></li><li data-type='method'><a href="Tily.TileLayer.html#getTile">getTile</a></li><li data-type='method'><a href="Tily.TileLayer.html#resize">resize</a></li><li data-type='method'><a href="Tily.TileLayer.html#setTile">setTile</a></li></ul></li><li><a href="Tily.Transition.html">Transition</a><ul class='methods'><li data-type='method'><a href="Tily.Transition.html#update">update</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="Tily.html">Tily</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">main.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>Tily.Main = (function() {
	"use strict";
	
	/**
	 * @typedef Size
	 * @type {Object}
	 * @property {Number} width The width.
	 * @property {Number} height The height.
	 */
	/**
	 * @callback beforeDrawFunction
	 * @param {Number} elapsedTime The time elapsed in seconds since the last draw call.
	 */
	/**
	 * @callback afterDrawFunction
	 * @param {Number} elapsedTime The time elapsed in seconds since the last draw call.
	 */
	/**
	 * @typedef TilyOptions
	 * @type {Object}
	 * @property {?Size} size The viewport size, or null to use the canvas element dimensions.
	 * @property {Boolean} handleResize True if the window resize event should be handled.
	 * @property {Boolean} showFPS True if the FPS should be displayed.
	 * @property {Boolean} renderLoop True if the render loop should be started automatically.
	 * @property {?beforeDrawFunction} beforeDrawFunction A function that will be called after
	 * clearing the context but before drawing the active buffer. In the context of the function,
	 * 'this' will point to the Tily instance.
	 * @property {?afterDrawFunction} afterDrawFunction A function that will be called after
	 * drawing the active buffer but before drawing any debug text. In the context of the function,
	 * 'this' will point to the Tily instance.
	 */
	/**
	 * Default Tily options, used as a fall-back for options passed to the constructor.
	 * @type {TilyOptions}
	 */
	const _defaultTilyOptions = {
		size: null,
		handleResize: true,
		showFPS: false,
		renderLoop: true,
		beforeDrawFunction: null,
		afterDrawFunction: null
	};
	
	/**
	 * The main Tily object. Initialises a canvas element and starts drawing tiles.
	 * @class
	 * @memberof Tily 
	 * @param {HTMLElement} canvas The canvas element in which to draw tiles.
	 * @param {TilyOptions} [options] An optional object containing options for configuring this
	 * Tily instance.
	 */
	function Main(canvas, options) {
		if (!window) {	// Check that we are in a browser (ie. window exists)
			console.log("Couldn't find window. Tily.Main can only be created in the browser!");
			return
		}
		if (!canvas.getContext) {	// Check for canvas support
			console.log("Canvas not supported!");
			return;
		}
		
		/**
		 * Options for configuring this Tily instance.
		 * @type {TilyOptions}
		 */
		this.options = {}.extend(_defaultTilyOptions, options || {});
		
		/**
		 * The canvas element in which to draw tiles.
		 * @type {HTMLElement}
		 */
		this.canvas = canvas;
		
		/**
		 * The context on which to draw tiles.
		 * @type {CanvasRenderingContext2D}
		 */
		this.context = canvas.getContext("2d");
		
		/**
		 * The viewport width.
		 * @type {Number}
		 */
		this.width = 0;
		
		/**
		 * The viewport height.
		 * @type {Number}
		 */
		this.height = 0;
		
		/**
		 * The buffer currently being rendered.
		 * @type {Tily.BufferBase}
		 */
		this.activeBuffer = null;
		
		/**
		 * The currently running buffer transition or null if there is no currently running
		 * transition.
		 * @default null
		 * @type {?Tily.BufferTransition}
		 */
		this.bufferTransition = null;
		
		/**
		 * A request id returned from window.requestAnimationFrame that uniquely identifies the
		 * entry in the callback list for the main render loop.
		 * @type {Number}
		 */
		this.loop = null;
		
		/**
		 * The unix epoch time of the last rendered frame.
		 * @type {Number}
		 */
		this.lastFrameTime = new Date();
		
		/**
		 * The number of frames rendered in the last second.
		 * @type {Number}
		 */
		this.frameCount = 0;
		
		/**
		 * The number of milliseconds elapsed since the last framerate update.
		 * @type {Number}
		 */
		this.frameTime = 0;
		
		/**
		 * The number of frames rendered per second.
		 * @type {Number}
		 */
		this.frameRate = 0;
		
		// Handle the window resize event to get the current viewport size or use a fixed size
		if (!this.options.size || this.options.handleResize) {
			const self = this;
			function resize() {
				self.canvas.width = self.width = canvas.clientWidth * window.devicePixelRatio;
				self.canvas.height = self.height = canvas.clientHeight * window.devicePixelRatio;
			}
			window.addEventListener("resize", resize, false);
			resize();
		} else {
			this.canvas.width = this.width = this.options.size.width;
			this.canvas.height = this.height = this.options.size.height;
		}
		
		// Start the render loop
		if (this.options.renderLoop) {
			loop(this);
		}
	}
	
	/**
	 * Perform a single iteration of the render loop.
	 * @param {Tily.Main} t The Tily instance being looped.
	 */
	function loop(t) {
		const now = new Date(),
			elapsedTime = (now - t.lastFrameTime) / 1000;
		t.lastFrameTime = now;
		t.frameTime += elapsedTime;
		t.frameCount++;
		if (t.frameTime > 1) {
			t.frameRate = t.frameCount;
			t.frameTime = 0;
			t.frameCount = 0;
		}
		t.draw(elapsedTime);
		t.loop = window.requestAnimationFrame(function() { loop(t) });
	}
	
	/**
	 * Render the Tily instance onto the canvas.
	 * @name draw
	 * @function
	 * @instance
	 * @memberof Tily.Main
	 * @param {Number} elapsedTime The time elapsed in seconds since the last draw call.
	 */
	Main.prototype.draw = function(elapsedTime) {
		this.context.save();
		this.context.clearRect(0, 0, this.width, this.height);
		if (this.options.showFPS) {
			debug.show("FPS", this.frameRate);
		}
		if (typeof this.options.beforeDrawFunction == "function") {
			this.options.beforeDrawFunction.call(this, elapsedTime);
		}
		
		// Draw the active buffer and handle buffer fade transition
		const width = this.width,
			height = this.height;
		if (this.bufferTransition) {
			const alpha = this.bufferTransition.update(elapsedTime);
			if (this.bufferTransition.start) {
				this.context.globalAlpha = 1 - alpha;
				this.bufferTransition.start.draw(this.context, elapsedTime, width, height);
			}
			if (this.bufferTransition.finish) {
				this.context.globalAlpha = alpha;
				this.bufferTransition.finish.draw(this.context, elapsedTime, width, height);
			}
			if (this.bufferTransition.finished) {	// Remove the transition when it has finished
				this.bufferTransition = null;
			}
		} else if (this.activeBuffer) {
			this.context.globalAlpha = 1;
			this.activeBuffer.draw(this.context, elapsedTime, width, height);
		}
		if (typeof this.options.afterDrawFunction == "function") {
			this.options.afterDrawFunction.call(this, elapsedTime);
		}
		debug.draw(this.context);
		this.context.restore();
	};
	
	/**
	 * Activate a new buffer with an optional fade transition from the current buffer.
	 * @name activateBuffer
	 * @function
	 * @instance
	 * @memberof Tily.Main
	 * @param {Tily.Buffer} buffer The new buffer to activate.
	 * @param {TransitionOptions} [options] An optional options object.
	 * @returns {Promise} A promise instance for setting a transition finished callback.
	 */
	Main.prototype.activateBuffer = function(buffer, options) {
		const transition = new Tily.BufferTransition(this.activeBuffer, buffer, options);
		this.bufferTransition = transition;
		this.activeBuffer = buffer;
		return new Promise(function(resolve, reject) { transition.finishedCallback = resolve; });
	};
	
	/**
	 * @name size
	 * @description The size of this Tily element measured in pixels.
	 * @instance
	 * @memberof Tily.Main
	 * @type {Size}
	 */
	Object.defineProperty(Main.prototype, "size", {
		get: function() {
			return {
				width: this.width,
				height: this.height
			};
		}
	});
	return Main;
}());</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon Jan 30 2017 20:18:57 GMT+0000 (GMT Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
